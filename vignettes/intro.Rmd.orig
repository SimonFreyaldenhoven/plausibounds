---
title: "Introduction to plausiblebounds: Computing Plausible Bounds for Treatment Path Estimates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to plausiblebounds}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
```

```{r setup}
library(plausibounds)
library(ggplot2)
```

## Overview

The `plausibounds` package provides tools for calculating and visualizing plausible bounds for treatment path estimates in event study designs. This methodology addresses a fundamental challenge in empirical research: how to construct confidence bands that properly account for the uncertainty in dynamic treatment effects while maintaining computational tractability.

The package implements the methodology described in Freyaldenhoven and Hansen (2025), which introduces a novel approach to constructing confidence bands that are both theoretically justified and practically useful. The key contribution is the use of two types of plausible bounds: **cumulative bounds** that target the average treatment effect, and **restricted bounds** that leverage data-driven smoothness properties of the underlying treatment path to provide tighter confidence intervals than traditional pointwise or simultaneous confidence bands.

## Key Concepts

### Treatment Path Estimation

In event study designs, researchers often estimate the dynamic effects of a treatment over multiple time horizons. These estimates form a "treatment path" that shows how the effect evolves over time. However, these estimates come with uncertainty, and properly quantifying this uncertainty is crucial for valid inference.

The package assumes access to point estimates $\hat{\beta}_h$ for horizons $h = 1, \ldots, H$ that follow $\hat{\beta} \sim N(\beta, V_\beta)$, where $\hat{\beta}$ collects the estimated dynamic treatment effect path and $V_\beta$ is the known covariance matrix.

### Types of Bounds

The package implements and visualizes several types of confidence bounds:

More traditional:
1. **Pointwise bounds**: Traditional confidence intervals calculated separately for each point in the path
2. **Simultaneous (sup-t) bounds**: Uniform confidence bands that cover the entire path with a specified probability

and central to this paper:
3. **Cumulative bounds**: Bounds that target the average treatment effect rather than the entire path
4. **Restricted bounds**: Novel bounds that use data-driven model selection with smoothness assumptions, providing uniform coverage for a selected surrogate path

## Basic Usage

### Example 1: Simple Case with IID Errors

Let's start with a simple example using constant estimates with independent and identically distributed (IID) errors:

```{r simple-example}
# Display the first few estimates of built in dataset `estimates_constant_iid`
head(estimates_constant_iid)

simple_pb <- plausible_bounds(
  estimates = estimates_constant_iid,
  var = var_constant_iid,
  alpha = 0.05
)

summary(simple_pb)
```

The `plausible_bounds()` function returns both cumulative and restricted bounds in a single data frame accessed via `summary(simple_pb)`. The cumulative bounds show the uncertainty in the average effect (not the sum), while the restricted bounds use data-driven model selection to choose an appropriate surrogate path (`surrogate`) and provide uniform coverage for that surrogate (in the columns `restr_lower` and `restr_upper`).


### Visualizing the Results

The package provides a flexible plotting function to visualize the bounds:

```{r plot-simple, fig.cap="Plausible bounds for constant estimates with IID errors"}
create_plot(simple_pb)
```

The plot shows:

- **Black points**: Original point estimates

- **Orange shaded area**: Cumulative bounds (targeting average effect)

- **Blue line**: Restricted (data-selected surrogate) estimate

- **Blue dashed lines**: Restricted bounds

and the more traditional bounds:

- **Grey vertical bars**: Sup-t intervals

- **Grey horizontal bars**: Pointwise intervals

## Example 2: Complex Case with Correlated Errors

Let's examine a case with wiggly estimates and strongly correlated errors:

```{r complex-example}

# Calculate bounds
wiggly_pb <- plausible_bounds(
  estimates = estimates_wiggly_strong_corr,
  var = var_wiggly_strong_corr,
  alpha = 0.05
)

# Create visualization
create_plot(wiggly_pb)
```

Notice how the restricted bounds (blue dashed lines) adapt to the underlying smoothness while still providing meaningful uncertainty quantification. The cumulative bounds (orange area) reflect the uncertainty in the average treatment effect across all horizons.

## Additional Features

You can also choose which types of bounds to calculate cumulative bounds (usually less computationally heavy) and restricted bounds, depending on your data.

```{r selective-bounds}
# Calculate only cumulative bounds
cumul_only <- calculate_cumulative_bounds(
  estimates = estimates_constant_iid,
  var = var_constant_iid,
  alpha = 0.05
)

# Calculate only restricted bounds
restr_only <- calculate_restricted_bounds(
  estimates = estimates_constant_iid,
  var = var_constant_iid,
  alpha = 0.05
)

# Plot them together in either order
create_plot(cumul_only, restr_only)
```

By default, `plausible_bounds()` computes the pointwise and sup-t bounds for comparison. However, you can choose not to calculate or display them by setting `include_pointwise` or `include_supt` to `FALSE`. This option is available across all functions. 

### Adjusting Visualizations

The plotting function offers control over which bounds to display:

```{r custom-plot}
# Hide cumulative bounds
create_plot(wiggly_pb, show_cumulative = FALSE)

# Hide sup-t and restricted bounds
create_plot(wiggly_pb, show_supt = FALSE, show_restricted = FALSE)
```

### Parallel Processing

The restricted bounds calculation can be computationally intensive so the package supports parallel processing via the `parallel` and `n_cores` arguments in `plausible_bounds()` and `calculate_restricted_bounds()`:

```{r parallel, eval=FALSE}
# Enable parallel processing for restricted bounds
parallel_pb <- plausible_bounds(
  estimates = estimates_wiggly_strong_corr,
  var = var_wiggly_strong_corr,
  alpha = 0.05,
  parallel = TRUE
)
```




--- 

## Theoretical Background

### Cumulative Bounds

The cumulative bounds target the average treatment effect rather than uniform coverage of the entire path. They are constructed as:

$$(U, L)_{1-\alpha} = \{w'\hat{\beta}/H \pm z_{1-\alpha/2}(w'V_\beta w)^{1/2}/H\}_{h=1}^H$$

where $w$ is a vector of ones and the bounds are constant across all horizons $h$. These bounds satisfy:

$$P\left(\sum_{h=1}^H L_{h}^{1-\alpha} < \sum_{h=1}^H \beta_h < \sum_{h=1}^H U_{h}^{1-\alpha}\right) = (1-\alpha)$$

This means the true treatment path will **on average** be within these bounds for $(1-\alpha)$ of all realizations.

### Restricted Bounds and Model Selection

The restricted bounds use data-driven model selection from a pre-specified universe of candidate models. The procedure:

1. **Model Universe**: Includes constant, linear, quadratic, and cubic models, plus models based on shrinkage of first and third differences motivated by smoothness and eventual decay

2. **Selection Criterion**: Uses a BIC-type criterion to select model $\hat{M}$

3. **Post-Selection Inference**: Applies Berk et al. (2013) to provide uniform coverage for the selected surrogate $\beta_{\hat{M}} = P(\hat{M})\beta$

The restricted bounds provide uniform coverage for the **selected surrogate path**, not the true path. This surrogate represents a data-driven approximation that captures key features while being potentially simpler than the true path.

### Properties and Practical Guidance

* **Cumulative bounds** quantify average effects and remain narrow even when sup-t bands are too wide to interpret.
* **Restricted bounds** adapt to smoothness and covariance structure, often yielding informative bands that reflect economically meaningful approximations and can be more policy-relevant.
* **Sup-t bands** remain the default for full-path uniform coverage but can be very wide, especially when horizons are many or estimates are strongly correlated.
* In applications, cumulative bounds are useful for assessing overall effect direction and magnitude, while restricted bounds provide a clearer picture of the main shape of the treatment path.


## Working with Your Own Data

To use the package with your own estimates:

```{r own-data, eval=FALSE}
# Prepare your data
my_estimates <- c(0.5, 0.7, 0.9, 1.1, 1.0, 0.8)  # Your point estimates
my_var <- diag(c(0.1, 0.12, 0.15, 0.18, 0.20, 0.22))  # Your variance-covariance matrix

# Calculate bounds
my_result <- plausible_bounds(
  estimates = my_estimates,
  var = my_var,
  alpha = 0.05
)

# Visualize
create_plot(my_result)
```

### Data Requirements

Your data must satisfy:
1. `estimates`: A numeric vector of point estimates $\hat{\beta}_h$

2. `var`: A symmetric, positive semi-definite variance-covariance matrix $V_\beta$

3. The dimension of `var` must match the length of `estimates`

4. The estimates should be approximately jointly normal: $\hat{\beta} \sim N(\beta, V_\beta)$

## References

Freyaldenhoven, S. and Hansen, C. (2025). "(Visualizing) Plausible Treatment Effect Paths." Federal Reserve Bank of Philadelphia and University of Chicago.

Berk, R., Brown, L., Buja, A., Zhang, K., and Zhao, L. (2013). "Valid post-selection inference." The Annals of Statistics, 41(2):802-837.
