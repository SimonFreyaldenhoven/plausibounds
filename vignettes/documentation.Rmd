---
title: "Introduction to plausiblebounds: Computing Plausible Bounds for Treatment Path Estimates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to plausiblebounds}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




``` r
library(plausiblebounds)
#> Error in library(plausiblebounds): there is no package called 'plausiblebounds'
library(ggplot2)
```

## Overview

When estimating treatment effect paths from event studies or dynamic panel data models, researchers often face a tension: pointwise confidence intervals fail to account for multiple testing, while uniform confidence bands (such as sup-t bands) can be too wide to provide useful inference. The `plausiblebounds` package implements methods from Freyaldenhoven and Hansen (2025) that provide an intermediate solution through **restricted bounds**—confidence regions that adapt to the smoothness and correlation structure of the data while maintaining valid post-selection coverage.

### Treatment Path Setup

Let $\hat{\beta} = (\hat{\beta}_1, \ldots, \hat{\beta}_H)$ denote estimates of treatment effects at horizons $h=1,\dots,H$, with

$$
\hat{\beta} \sim N(\beta, V_\beta),
$$

where $\beta$ is the true treatment path and $V_{\beta}$ is the variance-covariance matrix. This setup encompasses common estimators including distributed lag models, local projections, and two-way fixed effects event studies.

## Theoretical Background: Restricted Bounds

The key innovation of this package is the construction of **restricted bounds** through a data-driven surrogate path. Rather than attempting uniform coverage of the raw noisy estimates, restricted bounds provide valid inference for a smoothed approximation that may capture the policy-relevant features of the treatment path more clearly.

### Surrogate Paths and Model Selection

The approach approximates $\beta$ by a **surrogate path** $\beta_M = P(M)\beta$, where $M$ indexes a model in a pre-specified universe $\mathcal{M}$. The model universe includes polynomial specifications (constant, linear, quadratic, cubic) as well as penalized smoothing approaches that shrink first and third differences.

Given estimates $\hat{\beta}$, the surrogate for a given model $M$ is obtained by solving a penalized least squares problem:

$$
\tilde{\beta}(M) = \arg\min_b \Big[ (\hat{\beta} - b)'V_\beta^{-1}(\hat{\beta} - b)
  + \lambda_1 b'D_1'W_1(K)D_1 b
  + \lambda_2 b'D_3'W_3 D_3 b \Big],
$$

where $D_1$ and $D_3$ are first- and third-difference operators, and $\lambda_1$, $\lambda_2$, and $K$ are tuning parameters that control smoothness and the timing of decay toward zero. The solution has closed form:

$$
\tilde{\beta}(M) = P(M)\hat{\beta}, \quad P(M) = \Big(V_\beta^{-1} + \lambda_1 D_1'W_1(K)D_1 + \lambda_2 D_3'W_3D_3\Big)^{-1} V_\beta^{-1}.
$$

The best-fitting surrogate model $\hat{M}$ is selected by minimizing a BIC-type criterion:

$$
\hat{M} = \arg\min_{M \in \mathcal{M}} \; (\hat{\beta}-\tilde{\beta}(M))'V_\beta^{-1}(\hat{\beta}-\tilde{\beta}(M)) + \log(H)\,\text{df}(M),
$$

where the degrees of freedom is $\text{df}(M) = \mathrm{trace}(P(M))$.

### Post-Selection Inference

Once $\hat{M}$ is chosen, the package constructs confidence regions using post-selection inference (Berk et al. 2013), which accounts for the model selection step to guarantee valid coverage:

$$
\Pr\!\big(\beta_{\hat{M}} \in \text{CR}_{\text{PoSI}}\big) \ge 1-\alpha.
$$

This is a critical distinction: the restricted bounds provide uniform coverage for the *selected surrogate path* (a data-dependent smoothed approximation), not the true treatment path itself. Because the surrogate is smoother and may be more interpretable than the raw estimates, this inferential target may be more useful for policy analysis while remaining statistically rigorous.

The restricted bounds can be especially informative when the treatment path is expected to be relatively smooth (as in many economic applications) and when there is substantial correlation in the estimation errors across horizons. In these settings, restricted bounds can remain informative even when traditional sup-t bands become too wide to draw meaningful conclusions.


## Basic Usage

Let's start by examining the structure of the example datasets included in the package:


``` r
# Load example datasets
data(estimates_wiggly)
data(var_iid)
data(var_corr)

# Examine the data structures
print(estimates_wiggly)
#>  [1]  0.09554212 -0.10861223 -0.29680478 -0.32634657 -0.44833415 -0.33276043
#>  [7] -0.15294343 -0.27116602 -0.18957586 -0.33455712 -0.28824851 -0.17782216
dim(var_iid)
#> [1] 12 12
dim(var_corr)
#> [1] 12 12
```

The `estimates_wiggly` vector contains 12 treatment effect estimates at different horizons. The `var_iid` matrix is a diagonal variance-covariance matrix (independent errors), while `var_corr` includes correlation across horizons.

### Example 1: Independent Errors

The simplest case uses the `plausible_bounds()` function with just the estimates and variance-covariance matrix. The `alpha` parameter controls the confidence level (default is 0.05 for 95% confidence):


``` r
pb_iid <- plausible_bounds(
  estimates = estimates_wiggly,
  var = var_iid,
  alpha = 0.05
)
#> Calculating restricted bounds: ■■■■■■                           K = 2/11 [ 18%]Calculating restricted bounds: ■■■■■■■■■                        K = 3/11 [ 27%]Calculating restricted bounds: ■■■■■■■■■■■■                     K = 4/11 [ 36%]Calculating restricted bounds: ■■■■■■■■■■■■■■■                  K = 5/11 [ 45%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■                K = 6/11 [ 55%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■             K = 7/11 [ 64%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■          K = 8/11 [ 73%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■       K = 9/11 [ 82%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■■■     K = 10/11 [ 91%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■  K = 11/11 [100%]
```

The returned object is a list containing the bounds, test statistics, and metadata. The `summary()` method extracts the key results in a tabular format, showing the horizon, coefficient estimates, and restricted bounds:


``` r
summary(pb_iid)
#> Summary of Plausible Bounds Results
#> -----------------------------------
#> 
#>  horizon        coef   surrogate restr_lower  restr_upper
#>        1  0.09554212  0.08003022  -0.2527747  0.412835169
#>        2 -0.10861223 -0.12484663  -0.3276764  0.077983159
#>        3 -0.29680478 -0.25702728  -0.4548122 -0.059242328
#>        4 -0.32634657 -0.32916484  -0.5343129 -0.124016817
#>        5 -0.44833415 -0.35391239  -0.5462388 -0.161585995
#>        6 -0.33276043 -0.34392303  -0.5199829 -0.167863120
#>        7 -0.15294343 -0.31184986  -0.4910514 -0.132648319
#>        8 -0.27116602 -0.27034598  -0.4697459 -0.070946071
#>        9 -0.18957586 -0.23206449  -0.4449509 -0.019178092
#>       10 -0.33455712 -0.20965848  -0.4161487 -0.003168222
#>       11 -0.28824851 -0.21578106  -0.4359691  0.004406975
#>       12 -0.17782216 -0.26308531  -0.6277410  0.101570332
```

For a more detailed view of the object structure:


``` r
str(pb_iid, max.level = 1)
#> List of 7
#>  $ preperiods                : num 0
#>  $ wald_test                 :List of 1
#>  $ restricted_bounds         :'data.frame':	12 obs. of  5 variables:
#>  $ restricted_bounds_metadata:List of 10
#>  $ avg_treatment_effect      :List of 5
#>  $ pointwise_bounds          :List of 3
#>  $ supt_bounds               :List of 3
#>  - attr(*, "class")= chr "plausible_bounds"
```

The object contains several components. The `restricted_bounds` data frame includes the point estimates (`coef`), surrogate path (`surrogate`), and the lower and upper restricted bounds for each horizon. The `restricted_bounds_metadata` list stores important information about the model selection process, including the surrogate class selected (e.g., polynomial degree or penalized smoothing parameters), the degrees of freedom, and the sup-t critical value used in constructing the bounds. The `avg_treatment_effect` component provides the average treatment effect estimate, its standard error, and confidence interval. When `include_pointwise` and `include_supt` are `TRUE` (the default), the object also contains `pointwise_bounds` and `supt_bounds` lists with the alternative confidence bounds. Finally, `wald_test` contains test statistics and p-values for testing the null hypothesis of no treatment effect.


``` r
create_plot(pb_iid)
```

<div class="figure" style="text-align: center">
<img src="figs/plot-iid-1.png" alt="Plausible bounds for treatment path estimates with independent errors"  />
<p class="caption">Plausible bounds for treatment path estimates with independent errors</p>
</div>

### Understanding the Plot Elements

The plot displays several types of bounds and statistics, each serving a different inferential purpose:

**Point estimates (black dots)**: The raw treatment effect estimates $\hat{\beta}_h$ at each horizon. These are the starting point but provide no information about uncertainty.

**Restricted bounds (blue dashed lines)**: The main contribution of this package. These bounds provide uniform $(1-\alpha)$ coverage for the selected surrogate path (the smooth blue line), not the true treatment path itself. The surrogate path is chosen via BIC from the model universe and represents a data-dependent smoothed approximation to the true treatment path. The restricted bounds adapt to the smoothness and correlation structure, often remaining narrow enough to be informative.

**Pointwise bounds (gray horizontal bars)**: Standard confidence intervals for each horizon separately, constructed as $\hat{\beta}_h \pm z_{1-\alpha/2} \sqrt{V_{\beta,hh}}$. These do not account for multiple testing and should not be used for simultaneous inference across horizons.

**Sup-t bounds (gray vertical lines)**: Uniform confidence bands that provide $(1-\alpha)$ joint coverage of the entire treatment path. These are constructed using the critical value from the supremum of $t$-statistics. While they guarantee full-path coverage, they can become very wide when there are many horizons or strong correlation.

**Annotations**: The bottom of the plot shows several summary statistics. The "No effect p-value" comes from a Wald test of the null hypothesis that all treatment effects are zero. The "Average effect [CI]" provides the average treatment effect (ATE) $\bar{\beta} = \frac{1}{H}\sum_h \beta_h$ along with its confidence interval—this quantifies the overall magnitude of the treatment while remaining narrow even when individual horizons are uncertain.

### Example 2: Correlated Errors

When errors are correlated across horizons (common in dynamic settings), the restricted bounds adapt to the correlation structure. While high correlation can widen the restricted bounds compared to the independent error case, they often remain substantially narrower than sup-t bands:


``` r
pb_corr <- plausible_bounds(
  estimates = estimates_wiggly,
  var = var_corr,
  alpha = 0.05
)
#> Calculating restricted bounds: ■■■■■■                           K = 2/11 [ 18%]Calculating restricted bounds: ■■■■■■■■■                        K = 3/11 [ 27%]Calculating restricted bounds: ■■■■■■■■■■■■                     K = 4/11 [ 36%]Calculating restricted bounds: ■■■■■■■■■■■■■■■                  K = 5/11 [ 45%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■                K = 6/11 [ 55%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■             K = 7/11 [ 64%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■          K = 8/11 [ 73%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■       K = 9/11 [ 82%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■■■     K = 10/11 [ 91%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■  K = 11/11 [100%]

create_plot(pb_corr)
```

<div class="figure" style="text-align: center">
<img src="figs/corr-example-1.png" alt="Plausible bounds for treatment path estimates with correlated errors"  />
<p class="caption">Plausible bounds for treatment path estimates with correlated errors</p>
</div>

In this example, the restricted bounds are wider than in the IID case due to the correlation structure, but still provide much more informative inference than the sup-t bands, which have become quite wide.


## Event Studies with Pre-Treatment Periods

The package supports event study designs where some periods occur before treatment. This allows testing for pre-trends and distinguishing them from treatment effects. When specifying the `preperiods` argument, the function automatically computes two Wald tests: one testing $H_0$: no pre-trends in the pre-treatment periods, and another testing $H_0$: no treatment effect in the post-treatment periods. Both p-values appear in the plot annotations.


``` r
# Load pre-trends dataset
data(estimates_pretrends)
data(var_pretrends)

# Examine structure (6 pre-treatment + 6 post-treatment periods)
print(estimates_pretrends)
#>  [1] -0.4735980 -0.7570933 -0.9515343 -0.7072245 -1.0347901 -1.0508887
#>  [7] -0.8994436 -1.0287310 -1.0618578 -1.0832139 -1.1091063 -1.2844106
dim(var_pretrends)
#> [1] 12 12
```

### Specifying Pre-Treatment Periods

Use the `preperiods` argument to indicate how many of the initial estimates correspond to pre-treatment periods. Note that period 0 (the period immediately before treatment) is assumed to be normalized to zero and should not be included in the estimates vector:


``` r
pb_event <- plausible_bounds(
  estimates = estimates_pretrends,
  var = var_pretrends,
  alpha = 0.05,
  preperiods = 6  # First 6 elements are pre-treatment periods
)
#> Warning in setup_grid(20, loglam1_range, loglam2_range, K, var, 4, target_df):
#> Few gridpoints in range, results may be suboptimal
#> Warning in setup_grid(20, loglam1_range, loglam2_range, K, var, 4, target_df):
#> Few gridpoints in range, results may be suboptimal
#> Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■        K = 4/5 [ 80%]Calculating restricted bounds: ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■  K = 5/5 [100%]

print(pb_event)
#> Plausible Bounds Results
#> ========================
#> 
#> Wald Tests:
#>   Post-treatment (H0: no effect): stat = 221.419, p = 0.0000
#>   Pre-treatment (H0: no pre-trends): stat = 157.104, p = 0.0000
#> 
#> Average Treatment Effect:
#>   Estimate: -1.0778 (SE: 0.0741)
#>   95% CI: [-1.2231, -0.9325]
#> 
#> Restricted Bounds:
#>   Surrogate class: polynomial
#>   Degrees of freedom: 2.00
#>   Average width: 0.5212
#> 
#> Bounds by horizon:
#>  horizon       coef  surrogate     lower      upper
#>       -6 -0.4735980         NA        NA         NA
#>       -5 -0.7570933         NA        NA         NA
#>       -4 -0.9515343         NA        NA         NA
#>       -3 -0.7072245         NA        NA         NA
#>       -2 -1.0347901         NA        NA         NA
#>       -1 -1.0508887         NA        NA         NA
#>        1 -0.8994436 -0.9085589 -1.223084 -0.5940333
#>        2 -1.0287310 -0.9773018 -1.225144 -0.7294593
#>        3 -1.0618578 -1.0460447 -1.254296 -0.8377937
#>        4 -1.0832139 -1.1147876 -1.326339 -0.9032361
#>        5 -1.1091063 -1.1835305 -1.439622 -0.9274395
#>        6 -1.2844106 -1.2522734 -1.577626 -0.9269210
```


``` r
create_plot(pb_event)
```

<div class="figure" style="text-align: center">
<img src="figs/plot-pretrends-1.png" alt="Event study with pre-treatment periods showing pre-trends"  />
<p class="caption">Event study with pre-treatment periods showing pre-trends</p>
</div>

The vertical dashed line at event time 0 separates pre- and post-treatment periods. Pre-treatment estimates appear at negative horizons, revealing any pre-existing trends. The restricted bounds and surrogate path are only computed for the post-treatment periods, since the goal is inference on the treatment effect path.

The annotations now include both Wald test p-values. The "Pretrends p-value" tests whether the pre-treatment coefficients are jointly zero—a rejection indicates violations of parallel trends. The "No effect p-value" tests whether the post-treatment coefficients are jointly zero. In this example, the pre-trends test rejects, suggesting that parallel trends may not hold.


## Controlling Visualization

The `create_plot()` function provides several arguments to customize which elements appear in the plot. The `show_annotations` argument controls whether the Wald test results and average treatment effect are displayed at the bottom. The `show_supt` and `show_pointwise` arguments control whether sup-t and pointwise bounds are included. For a cleaner display focusing only on the restricted bounds:


``` r
create_plot(pb_corr, show_annotations = FALSE, show_supt = FALSE)
```

<div class="figure" style="text-align: center">
<img src="figs/viz-custom-1.png" alt="Customized plot showing only point estimates and restricted bounds"  />
<p class="caption">Customized plot showing only point estimates and restricted bounds</p>
</div>


## Parallel Processing

For datasets with many horizons, the restricted bounds calculation can be time-consuming due to the model selection procedure. The `parallel` argument enables parallel computation across the model universe. Use `n_cores` to specify the number of cores (the default uses all available cores minus one):


``` r
pb_parallel <- plausible_bounds(
  estimates = estimates_wiggly,
  var = var_corr,
  alpha = 0.05,
  parallel = TRUE,
  n_cores = 4
)
```


## References

* Freyaldenhoven, S. and Hansen, C. (2025). "(Visualizing) Plausible Treatment Effect Paths." Federal Reserve Bank of Philadelphia and University of Chicago.
* Berk, R., Brown, L., Buja, A., Zhang, K., and Zhao, L. (2013). "Valid post-selection inference." *Annals of Statistics*, 41(2):802-837.
